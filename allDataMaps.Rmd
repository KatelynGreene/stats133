---
title: "allDataMaps"
author: ""
date: ""
output: 
  html_document:
    fig_height: 3
    fig_width: 5
---
<!-- Don't edit in between this line and the one below -->
```{r include=FALSE}
# Don't delete this chunk if you are using the DataComputing package
library(DataComputing)
library(readr)
library(rgdal)

library(sp)
library(rgeos)
library(rgdal)
library(maptools)
library(dplyr)
library(leaflet)
library(scales)
```
*Source file* 
```{r, results='asis', echo=FALSE}
includeSourceDocuments()
```
<!-- Don't edit the material above this line -->
Need to have all_data in your workspace, get it from CleanAndJoinData



-------------------
Visualization
-------------------

```{r}

GetCountyShapefile <- function(){
  
  # Download county shape file from Tiger.
  # https://www.census.gov/geo/maps-data/data/cbf/cbf_counties.html
  #location <- "C:\\Users\\Katrlyn\\stats133Project\\cb_2016_us_county_500k"
  #us.map <- readOGR(dsn = location, layer = "cb_2016_us_county_500k", stringsAsFactors = FALSE)
  
  # Other Download method
  library(tigris)
  # Download county shape file from US Census using streamlined TIGRIS package. 
  #cb = TRUE indicates that we're choosing simplified cartographic boundaries
  us.map <- tigris::counties(cb = TRUE, year = 2015)
  
  # Clean county shapefile 
  
  # Remove Alaska(2), Hawaii(15), Puerto Rico (72), Guam (66), Virgin Islands (78), American Samoa (60)
  # Mariana Islands (69), Micronesia (64), Marshall Islands (68), Palau (70), Minor Islands (74)
  us.map <- us.map[!us.map$STATEFP %in% c("02", "15", "72", "66", "78", "60", "69",
                                          "64", "68", "70", "74"),]
  # Make sure other outling islands are removed.
  us.map <- us.map[!us.map$STATEFP %in% c("81", "84", "86", "87", "89", "71", "76",
                                          "95", "79"),]

  return(us.map)  
}

```
------------------
Visualization Prep
-----------------

```{r}

countyShapefile <- GetCountyShapefile()

small_data <- all_data %>% 
  select(FIPSCode, UrbanCode, Income,Unemployment, Pollution, TreeCanopy, AvailGreenSpace, TreeCanopyCover)


# Merge spatial df with air quality data.
counties <- geo_join(countyShapefile, small_data, "GEOID", "FIPSCode", how = "left")

```


----------
Income
----------
```{r}

# Format popup data for leaflet map.
popup_dat <- paste(sep = "<br/>",
  "<b>County: </b>", 
  counties$NAME, 
  "<b>Value: </b>", 
  counties$Income)


#pal <- colorQuantile("YlOrRd", NULL, n = 9)  #Manual color bins

#Let leaflet calculate the colors and labels for you 
pal <- colorNumeric(
  palette =  "YlGnBu",
  domain = counties$Income
)

# Render final map in leaflet.

map <- leaflet(counties) %>% addTiles()

income_map <- map %>% 
  addPolygons(stroke = TRUE, color = "white", weight = .1, smoothFactor = 0.5, opacity = 1, 
    fillColor = ~pal(Income), fillOpacity = 1, popup = popup_dat, 
    highlight = highlightOptions(color = "#666", weight = 2, bringToFront = TRUE)) %>%
  addLegend("bottomright", pal = pal, values = ~Income,
    title = "Median Household Income (2015)",
    labFormat = labelFormat(prefix = "$"), na.label = "county data missing",
    opacity = 1)

income_map
```
-------------------
Unemployment rate
------------------
```{r}

# Format popup data for leaflet map.
popup_dat <- paste(sep = "<br/>",
  "<b>County: </b>", 
  counties$NAME, 
  "<b>Value: </b>",  
  counties$Unemployment)


#pal <- colorQuantile("YlOrRd", NULL, n = 9)  #Manual color bins

#Let leaflet calculate the colors and labels for you 
pal <- colorNumeric(
  palette =  "YlGnBu",
  domain = counties$Unemployment
)


# Render final map in leaflet.

map <- leaflet(counties) %>% addTiles()

unemploy_map <- map %>% 
  addPolygons(stroke = TRUE, color = "white", weight = .1, smoothFactor = 0.5, opacity = 1, 
    fillColor = ~pal(Unemployment), fillOpacity = 1, popup = popup_dat, 
    highlight = highlightOptions(color = "#666", weight = 2, bringToFront = TRUE)) %>%
  addLegend("bottomright", pal = pal, values = ~Unemployment,
    title = "Unemployment Rate (2015)",
    labFormat = labelFormat(suffix = "%"), na.label = "county data missing",
    opacity = 1)

unemploy_map
```
---------------------------------
Pollution leaflet visualization
--------------------------------

```{r}
# Format popup data for leaflet map.
popup_dat <- paste(sep = "<br/>",
  "<b>County: </b>", 
  counties$NAME, 
  "<b>Value: </b>", 
  counties$Pollution)

#Let leaflet calculate the colors and labels for you 
pal <- colorNumeric(
  palette =  "YlGnBu",
  domain = counties$Pollution
)

# Render base map
map <- leaflet(counties) %>% addTiles()

pollution_map <- map %>% 
  #Stroke indicates outline presence
  #smoothFactor: how much to simplify the polyline on each zoom level (more means better performance and less accurate representation)
  addPolygons(stroke = TRUE, color = "white", weight = .1, smoothFactor = 0.5, opacity = 1, 
    fillColor = ~pal1(Pollution), fillOpacity = 1, popup = popup_dat1, 
    highlight = highlightOptions(color = "#666", weight = 2, bringToFront = TRUE), group = "Pollution") %>%
  addLegend("bottomright", pal = pal, values = ~Pollution,
    title = "Pollution Data",
    labFormat = labelFormat(suffix = "µg/m³"), na.label = "county data missing",
    opacity = 1) 

pollution_map
```




#TreeCanopy
```{r}
# Format popup data for leaflet map.
popup_dat <- paste(sep = "<br/>",
  "<b>County: </b>", 
  counties$NAME, 
  "<b>Value: </b>", 
  counties$TreeCanopy)


#Let leaflet calculate the colors and labels for you 
pal <- colorNumeric(
  palette =  "YlGnBu",
  domain = counties$TreeCanopy, n= 9
)

#pal <- colorQuantile("YlGnBu", NULL, n = 9)  #Manual color bins

# Render map in leaflet.
map <- leaflet(counties) %>% addTiles()

treeCanopy_map <- map %>% 
  addPolygons(stroke = TRUE, color = "white", weight = .1, smoothFactor = 0.5, opacity = 1, 
    fillColor = ~pal(TreeCanopy), fillOpacity = 1, popup = popup_dat, 
    highlight = highlightOptions(color = "#666", weight = 2, bringToFront = TRUE)) %>%
  addLegend("bottomright", pal = pal, values = ~TreeCanopy,
    title = "Tree canopy Covering",
    labFormat = labelFormat(suffix = " m2/person"), na.label = "county data missing",
    opacity = 1)

treeCanopy_map
```



mapping 2013 Urban Influence
```{r}

countyShapefile <- GetCountyShapefile()


urban_small<- all_data %>% 
  select(FIPSCode, `2013 Urban Influence Code`)

colnames(urban_small) <- c("GEOID", "InfluenceCode")


urban_small[duplicated(urban_small),]


# Merge spatial df with air quality data.
#counties <- merge(countyShapefile, small_data, by=c("GEOID"))

counties <- geo_join(countyShapefile, urban_small, "GEOID", "GEOID", how = "left")


#Leftoin isn't used because cannot left join this data! 
#leafmap <- us.map %>% left_join(county_dat, by = c("GEOID"))

# Format popup data for leaflet map.
popup_dat <- paste(sep = "<br/>",
  "<b>County: </b>", 
  counties$NAME, 
  "<b>Value: </b>", 
  counties$InfluenceCode)


#pal <- colorQuantile("YlOrRd", NULL, n = 9)  #Manual color bins

#Let leaflet calculate the colors and labels for you 
pal <- colorNumeric(
  palette =  "YlGnBu",
  domain = counties$InfluenceCode
)


# Render final map in leaflet.

map <- leaflet(counties) %>% addTiles()

map %>% 
  #Stroke indicates outline presence
  #smoothFactor: how much to simplify the polyline on each zoom level (more means better performance and less accurate representation)
  addPolygons(stroke = TRUE, color = "white", weight = .1, smoothFactor = 0.5, opacity = 1, 
    fillColor = ~pal(InfluenceCode), fillOpacity = 1, popup = popup_dat, 
    highlight = highlightOptions(color = "#666", weight = 2, bringToFront = TRUE)) %>%
  addLegend("bottomright", pal = pal, values = ~InfluenceCode,
    title = "Urban Influence Code (2013)",
    labFormat = labelFormat(suffix = "Units"), na.label = "county data missing",
    opacity = 1)
```



mapping AvailGreenSpace
```{r}

countyShapefile <- GetCountyShapefile()


greenSpace_small<- all_data %>% 
  select(FIPSCode, AvailGreenSpace)

colnames(greenSpace_small) <- c("GEOID", "AvailGreenSpace")


greenSpace_small[duplicated(greenSpace_small),]


# Merge spatial df with air quality data.
#counties <- merge(countyShapefile, small_data, by=c("GEOID"))

counties <- geo_join(countyShapefile, greenSpace_small, "GEOID", "GEOID", how = "left")


#Leftoin isn't used because cannot left join this data! 
#leafmap <- us.map %>% left_join(county_dat, by = c("GEOID"))

# Format popup data for leaflet map.
popup_dat <- paste(sep = "<br/>",
  "<b>County: </b>", 
  counties$NAME, 
  "<b>Value: </b>", 
  counties$AvailGreenSpace)


#pal <- colorQuantile("YlOrRd", NULL, n = 9)  #Manual color bins

#Let leaflet calculate the colors and labels for you 
pal <- colorNumeric(
  palette =  "YlGnBu",
  domain = counties$AvailGreenSpace
)


# Render final map in leaflet.

map <- leaflet(counties) %>% addTiles()

map %>% 
  #Stroke indicates outline presence
  #smoothFactor: how much to simplify the polyline on each zoom level (more means better performance and less accurate representation)
  addPolygons(stroke = TRUE, color = "white", weight = .1, smoothFactor = 0.5, opacity = 1, 
    fillColor = ~pal(AvailGreenSpace), fillOpacity = 1, popup = popup_dat, 
    highlight = highlightOptions(color = "#666", weight = 2, bringToFront = TRUE)) %>%
  addLegend("bottomright", pal = pal, values = ~AvailGreenSpace,
    title = "Available Green Space",
    labFormat = labelFormat(suffix = "Units"), na.label = "county data missing",
    opacity = 1)
```


mapping Tree Canopy Cover
```{r}

countyShapefile <- GetCountyShapefile()

canopyCover_small<- all_data %>% 
  select(FIPSCode, TreeCanopyCover)

colnames(canopyCover_small) <- c("GEOID", "TreeCanopyCover")


canopyCover_small[duplicated(canopyCover_small),]


# Merge spatial df with air quality data.
#counties <- merge(countyShapefile, small_data, by=c("GEOID"))

counties <- geo_join(countyShapefile, canopyCover_small, "GEOID", "GEOID", how = "left")


#Leftoin isn't used because cannot left join this data! 
#leafmap <- us.map %>% left_join(county_dat, by = c("GEOID"))

# Format popup data for leaflet map.
popup_dat <- paste(sep = "<br/>",
  "<b>County: </b>", 
  counties$NAME, 
  "<b>Value: </b>", 
  counties$TreeCanopyCover)


#pal <- colorQuantile("YlOrRd", NULL, n = 9)  #Manual color bins

#Let leaflet calculate the colors and labels for you 
pal <- colorNumeric(
  palette =  "YlGnBu",
  domain = counties$TreeCanopyCover
)


# Render final map in leaflet.

map <- leaflet(counties) %>% addTiles()

map %>% 
  #Stroke indicates outline presence
  #smoothFactor: how much to simplify the polyline on each zoom level (more means better performance and less accurate representation)
  addPolygons(stroke = TRUE, color = "white", weight = .1, smoothFactor = 0.5, opacity = 1, 
    fillColor = ~pal(TreeCanopyCover), fillOpacity = 1, popup = popup_dat, 
    highlight = highlightOptions(color = "#666", weight = 2, bringToFront = TRUE)) %>%
  addLegend("bottomright", pal = pal, values = ~TreeCanopyCover,
    title = "Tree Canopy Cover",
    labFormat = labelFormat(suffix = "Units"), na.label = "county data missing",
    opacity = 1)
```

mapping `Percent of adults with less than a high school diploma, 2011-2015`
```{r}

countyShapefile <- GetCountyShapefile()

lessThanHS_small<- all_data %>% 
  select(FIPSCode, `Percent of adults with less than a high school diploma, 2011-2015`)

colnames(lessThanHS_small) <- c("GEOID", "LessThanHS")


lessThanHS_small[duplicated(lessThanHS_small),]


# Merge spatial df with air quality data.
#counties <- merge(countyShapefile, small_data, by=c("GEOID"))

counties <- geo_join(countyShapefile, lessThanHS_small, "GEOID", "GEOID", how = "left")


#Leftoin isn't used because cannot left join this data! 
#leafmap <- us.map %>% left_join(county_dat, by = c("GEOID"))

# Format popup data for leaflet map.
popup_dat <- paste(sep = "<br/>",
  "<b>County: </b>", 
  counties$NAME, 
  "<b>Value: </b>", 
  counties$LessThanHS)


#pal <- colorQuantile("YlOrRd", NULL, n = 9)  #Manual color bins

#Let leaflet calculate the colors and labels for you 
pal <- colorNumeric(
  palette =  "YlGnBu",
  domain = counties$LessThanHS
)


# Render final map in leaflet.

map <- leaflet(counties) %>% addTiles()

map %>% 
  #Stroke indicates outline presence
  #smoothFactor: how much to simplify the polyline on each zoom level (more means better performance and less accurate representation)
  addPolygons(stroke = TRUE, color = "white", weight = .1, smoothFactor = 0.5, opacity = 1, 
    fillColor = ~pal(LessThanHS), fillOpacity = 1, popup = popup_dat, 
    highlight = highlightOptions(color = "#666", weight = 2, bringToFront = TRUE)) %>%
  addLegend("bottomright", pal = pal, values = ~LessThanHS,
    title = "Percent of adults with less than a high school diploma, 2011-2015",
    labFormat = labelFormat(suffix = "Units"), na.label = "county data missing",
    opacity = 1)
```

`Percent of adults with a high school diploma only, 2011-2015`
```{r}

countyShapefile <- GetCountyShapefile()

HSDip_small<- all_data %>% 
  select(FIPSCode, `Percent of adults with a high school diploma only, 2011-2015`)

colnames(HSDip_small) <- c("GEOID", "HSDip")


lessThanHS_small[duplicated(lessThanHS_small),]


# Merge spatial df with air quality data.
#counties <- merge(countyShapefile, small_data, by=c("GEOID"))

counties <- geo_join(countyShapefile, HSDip_small, "GEOID", "GEOID", how = "left")


#Leftoin isn't used because cannot left join this data! 
#leafmap <- us.map %>% left_join(county_dat, by = c("GEOID"))

# Format popup data for leaflet map.
popup_dat <- paste(sep = "<br/>",
  "<b>County: </b>", 
  counties$NAME, 
  "<b>Value: </b>", 
  counties$HSDip)


#pal <- colorQuantile("YlOrRd", NULL, n = 9)  #Manual color bins

#Let leaflet calculate the colors and labels for you 
pal <- colorNumeric(
  palette =  "YlGnBu",
  domain = counties$HSDip
)


# Render final map in leaflet.

map <- leaflet(counties) %>% addTiles()

map %>% 
  #Stroke indicates outline presence
  #smoothFactor: how much to simplify the polyline on each zoom level (more means better performance and less accurate representation)
  addPolygons(stroke = TRUE, color = "white", weight = .1, smoothFactor = 0.5, opacity = 1, 
    fillColor = ~pal(HSDip), fillOpacity = 1, popup = popup_dat, 
    highlight = highlightOptions(color = "#666", weight = 2, bringToFront = TRUE)) %>%
  addLegend("bottomright", pal = pal, values = ~HSDip,
    title = "`Percent of adults with a high school diploma only, 2011-2015",
    labFormat = labelFormat(suffix = "Units"), na.label = "county data missing",
    opacity = 1)
```

mapping Percent of adults completing some college or associate's degree, 2011-2015
```{r}

countyShapefile <- GetCountyShapefile()

college_small<- all_data %>% 
  select(FIPSCode, `Percent of adults completing some college or associate's degree, 2011-2015`)

colnames(college_small) <- c("GEOID", "College")


college_small[duplicated(college_small),]


# Merge spatial df with air quality data.
#counties <- merge(countyShapefile, small_data, by=c("GEOID"))

counties <- geo_join(countyShapefile, college_small, "GEOID", "GEOID", how = "left")


#Leftoin isn't used because cannot left join this data! 
#leafmap <- us.map %>% left_join(county_dat, by = c("GEOID"))

# Format popup data for leaflet map.
popup_dat <- paste(sep = "<br/>",
  "<b>County: </b>", 
  counties$NAME, 
  "<b>Value: </b>", 
  counties$College)


#pal <- colorQuantile("YlOrRd", NULL, n = 9)  #Manual color bins

#Let leaflet calculate the colors and labels for you 
pal <- colorNumeric(
  palette =  "YlGnBu",
  domain = counties$College
)


# Render final map in leaflet.

map <- leaflet(counties) %>% addTiles()

map %>% 
  #Stroke indicates outline presence
  #smoothFactor: how much to simplify the polyline on each zoom level (more means better performance and less accurate representation)
  addPolygons(stroke = TRUE, color = "white", weight = .1, smoothFactor = 0.5, opacity = 1, 
    fillColor = ~pal(College), fillOpacity = 1, popup = popup_dat, 
    highlight = highlightOptions(color = "#666", weight = 2, bringToFront = TRUE)) %>%
  addLegend("bottomright", pal = pal, values = ~College,
    title = "Percent of adults completing some college or associate's degree, 2011-2015",
    labFormat = labelFormat(suffix = "Units"), na.label = "county data missing",
    opacity = 1)
```

mapping Percent of adults with a bachelor's degree or higher, 2011-2015
```{r}

countyShapefile <- GetCountyShapefile()

bach_small<- all_data %>% 
  select(FIPSCode, `Percent of adults with a bachelor's degree or higher, 2011-2015`)

colnames(bach_small) <- c("GEOID", "Bachelor")


bach_small[duplicated(bach_small),]


# Merge spatial df with air quality data.
#counties <- merge(countyShapefile, small_data, by=c("GEOID"))

counties <- geo_join(countyShapefile, bach_small, "GEOID", "GEOID", how = "left")


#Leftoin isn't used because cannot left join this data! 
#leafmap <- us.map %>% left_join(county_dat, by = c("GEOID"))

# Format popup data for leaflet map.
popup_dat <- paste(sep = "<br/>",
  "<b>County: </b>", 
  counties$NAME, 
  "<b>Value: </b>", 
  counties$Bachelor)


#pal <- colorQuantile("YlOrRd", NULL, n = 9)  #Manual color bins

#Let leaflet calculate the colors and labels for you 
pal <- colorNumeric(
  palette =  "YlGnBu",
  domain = counties$Bachelor
)


# Render final map in leaflet.

map <- leaflet(counties) %>% addTiles()

map %>% 
  #Stroke indicates outline presence
  #smoothFactor: how much to simplify the polyline on each zoom level (more means better performance and less accurate representation)
  addPolygons(stroke = TRUE, color = "white", weight = .1, smoothFactor = 0.5, opacity = 1, 
    fillColor = ~pal(Bachelor), fillOpacity = 1, popup = popup_dat, 
    highlight = highlightOptions(color = "#666", weight = 2, bringToFront = TRUE)) %>%
  addLegend("bottomright", pal = pal, values = ~Bachelor,
    title = "Percent of adults with a bachelor's degree or higher, 2011-2015",
    labFormat = labelFormat(suffix = "Units"), na.label = "county data missing",
    opacity = 1)
```




#Playing with Layer Control

```{r}
# Format popup data for leaflet map.
popup_dat1 <- paste(sep = "<br/>",
  "<b>County: </b>", 
  counties$NAME, 
  "<b>Value: </b>", 
  counties$Pollution)

popup_dat2 <- paste(sep = "<br/>",
  "<b>County: </b>", 
  counties$NAME, 
  "<b>Value: </b>", 
  counties$UrbanCode)

popup_dat3 <- paste(sep = "<br/>",
  "<b>County: </b>", 
  counties$NAME, 
  "<b>Value: </b>", 
  counties$Income)


#Let leaflet calculate the colors and labels for you 
pal1 <- colorNumeric(
  palette =  "YlGnBu",
  domain = counties$Pollution
)

pal2 <- colorNumeric(
  palette =  "YlGnBu",
  domain = counties$UrbanCode
)

pal3 <- colorNumeric(
  palette =  "YlGnBu",
  domain = counties$Income
)

# Render final map in leaflet.

map <- leaflet(counties) %>% addTiles()

map %>% 
  #Base Groups
  #Stroke indicates outline presence
  #smoothFactor: how much to simplify the polyline on each zoom level (more means better performance and less accurate representation)
  addPolygons(stroke = TRUE, color = "white", weight = .1, smoothFactor = 0.5, opacity = 1, 
    fillColor = ~pal1(Pollution), fillOpacity = 1, popup = popup_dat1, 
    highlight = highlightOptions(color = "#666", weight = 2, bringToFront = TRUE), group = "Pollution") %>%
  addPolygons(stroke = TRUE, color = "white", weight = .1, smoothFactor = 0.5, opacity = 1, 
    fillColor = ~pal2(UrbanCode), fillOpacity = 1, popup = popup_dat2, 
    highlight = highlightOptions(color = "#666", weight = 2, bringToFront = TRUE), group = "UrbanInfluenceCodes") %>% 
  # addPolygons(stroke = TRUE, color = "white", weight = .1, smoothFactor = 0.5, opacity = 1, 
  #   fillColor = ~pal3(HouseholdIncome2015), fillOpacity = 1, popup = popup_dat3, 
  #   highlight = highlightOptions(color = "#666", weight = 2, bringToFront = TRUE), group = "HouseholdIncome2015") %>% 
  
  # Layers control
  addLayersControl(
    baseGroups = c("Pollution", "UrbanInfluenceCodes"),
    options = layersControlOptions(collapsed = FALSE)
  ) 


```
