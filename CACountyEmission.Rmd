---
title: "Scraping Emissions in California Counties"
author: "Team Senioritis"
date: "4/19/17"
output: 
  html_document:
    fig_height: 3
    fig_width: 5
---
<!-- Don't edit in between this line and the one below -->
```{r include=FALSE}
# Don't delete this chunk if you are using the DataComputing package
library(DataComputing)
```
*Source file* 
```{r, results='asis', echo=FALSE}
includeSourceDocuments()
```
<!-- Don't edit the material above this line -->

The purpose of this document is to extract emissions data from all the counties in California. 
The original data source is:
https://www.arb.ca.gov/ei/maps/statemap/cntymap.htm.

Extracts the links to each county from the main link:
https://www.arb.ca.gov/ei/maps/statemap/cntymap.htm
```{r}
library(XML)
library(RCurl)
URL <- "https://www.arb.ca.gov/ei/maps/statemap/cntymap.htm"
txt <- getURLContent(URL)
doc <- htmlParse(txt)
#link <- doc %>% getNodeSet('//td/ul/li/a/@href')

#Scrape the county name
countyName <- xpathSApply(doc, "//td/ul/li/a", xmlValue)

#Clean up stray \n and \t in names
for(i in 1:length(countyName)){
  countyName[i] <- gsub("\\n", "", countyName[i])
  countyName[i] <- gsub("\\t", " ", countyName[i])
}

#Scrape the county link
countyLink <- doc %>% xpathSApply('//td/ul/li/a/@href')
countyLink <- as.character(countyLink)

#Clean up stray \n in links
for(i in 1:length(countyLink)){
  countyLink[i] <- gsub("\\n", "", countyLink[i])
}

#dataframe of countyName and countyLink
df <- as.data.frame(countyName, countyLink)

head(df)
```


Scrape the csv download handle links from each county's data page. 
```{r}

downloadLinks <- vector(mode="character", length=length(df$countyLink))

for(i in 1:length(countyLink)){
  URL <- countyLink[i]

  txt <- getURLContent(URL)
  doc <- htmlParse(txt)
    
  downloadLink <- doc %>% xpathSApply('//div[@id="content_area"]/a/@href')
  
  df <- as.data.frame(downloadLink)
  
  downloadLinks[i] <- as.character(df$downloadLink[1])
  
}

downloadLinks

```


Load each dataset into R for further processing. Csv files are read-in and assigned to the respective county name.

```{r}

for(i in 1:length(countyLink)){
  myURL <- paste("https://www.arb.ca.gov/app/emsinv/2013/", downloadLinks[i], sep = "")

  assign(countyName[i], read.csv(myURL))
}

head(Yuba)

#Accessing names:
#as.name(countyName[1])


```

