---
title: "JoinAllTables"
author: "Vanessa"
date: ""
output: 
  html_document:
    fig_height: 3
    fig_width: 5
---
<!-- Don't edit in between this line and the one below -->
```{r include=FALSE}
# Don't delete this chunk if you are using the DataComputing package
library(DataComputing)
library(RCurl)
library(readxl)
library(mosaic)
library(readr)
library(tidyr) 
library(dplyr)
library(stringi)
library(XML)
```
*Source file* 
```{r, results='asis', echo=FALSE}
includeSourceDocuments()
```
<!-- Don't edit the material above this line -->


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Downloading the USACountyEduAttainment data
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```{r}
#download/wrangle the USACountyEduAttainment data
download.file("https://www.ers.usda.gov/webdocs/DataFiles/CountyLevel_Data_Sets_Download_Data__18026/Education.xls?v=42762", destfile = "~/Downloads/stats133data/edu.xls", mode = "wb" )
#"/Users/anishakumar/Documents/Stats 133/RStudio Files/Stats133Project/edu.xls"
edu_data_unclean <- read_excel("/Users/anishakumar/Documents/Stats 133/RStudio Files/Stats133Project/edu.xls", sheet = 1, skip = 4)
edu_data<-edu_data_unclean[, grep("2011|FIPS Code", colnames(edu_data_unclean))]
edu_data<-edu_data[, grep("Percent|FIPS Code", colnames(edu_data))]
edu_data<-edu_data%>%dplyr::rename(FIPSCode=`FIPS Code`)
#/Users/anishakumar/Documents/Stats 133/RStudio Files/Stats133Project/edu.xls
```

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Downloading the PollutionPerCounty data
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```{r}
#dowload/wrangle the PollutionPerCounty data
poll_county_unclean<-read.csv("https://data.cdc.gov/api/views/cjae-szjv/rows.csv?accessType=DOWNLOAD")
poll_county<-poll_county_unclean %>%
  filter(MeasureType=='Average')%>%
  group_by(ReportYear)%>%
  arrange(CountyName)%>%
  arrange(StateName)%>%
  dplyr::rename(FIPSCode=CountyFips)%>%
  subset(select=c(FIPSCode, ReportYear, Value, Unit))%>%mutate(FIPSCode=gsub("46113","46102", FIPSCode))%>%filter(ReportYear==2010)%>%subset(select=-c(ReportYear))
poll_county$FIPSCode<-stri_pad_left(poll_county$FIPSCode, 5, "0")

```

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Downloading the CountyReferenceTable data
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

```{r}
#download/clean CountyReferenceTable data
every_us_county <- 
  "https://en.wikipedia.org/wiki/List_of_United_States_counties_and_county_equivalents" %>%
  read_html() %>%
  html_nodes(xpath = '//*[@id="mw-content-text"]/table') %>%
  html_table(fill=TRUE)
every_us_county2<-every_us_county[[2]]
every_county<-every_us_county2%>%
  dplyr::rename(FIPSCode=INCITS, County=`County or equivalent`, State=`State or district`)%>%
  subset(select=c( `FIPSCode`, `County`, `State`))
every_county$FIPSCode<-stri_pad_left(every_county$FIPSCode, 5, "0")
every_county<-mutate(every_county,StateFips=substr(every_county$FIPSCode,1,2))
View(every_county)
```

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Downloading the USACountyIncomeEmploy data
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

```{r}
#download/clean USACountyIncomeEmploy data

download.file("https://www.ers.usda.gov/webdocs/DataFiles/CountyLevel_Data_Sets_Download_Data__18026/Unemployment.xls?v=42762", destfile = "/Users/anishakumar/Documents/Stats 133/RStudio Files/Stats133Project/income.xls", mode = "wb" )
#"/Users/anishakumar/Documents/Stats 133/RStudio Files/Stats133Project/income.xls"
income_unclean <- read_excel("/Users/anishakumar/Documents/Stats 133/RStudio Files/Stats133Project/income.xls", sheet = 1, skip = 7)
head(data)
income<- income_unclean %>% mutate(Area_name= gsub(", ..$", "", Area_name), Area_name)%>%subset(select=c("FIPStxt","Median_Household_Income_2015","Unemployment_rate_2015"))%>%dplyr::rename(FIPSCode=FIPStxt)

```

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Downloading the USCountyUrbanForest data (time downlaoded: 3)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

```{r}
URL <- "https://www.nrs.fs.fed.us/data/urban/"
txt <- getURLContent(URL)
doc <- htmlParse(txt)

#Scrape the county name
stateNames <- xpathSApply(doc, '//ul/li/a/strong', xmlValue)

#****NOTE: Missing Alaska and Hawaii*******
stateLinks <- xpathSApply(doc, '//ul[@class="state_list"]/li/a/@href')
baseURL <- "https://www.nrs.fs.fed.us"
stateLinks <- paste(baseURL,as.character(stateLinks),sep="")

#Data Frame of StateName and stateLink
AllStates <- data.frame(stateNames, stateLinks, stringsAsFactors = FALSE)
AllStates 

AllStates[46, "stateNames"] <- "District of Columbia"
AllStates
```

Extracts the excel file download link for each state
```{r}
downloadLinks <- vector(mode="character", length=length(AllStates$stateNames))

for (i in 1:length(stateLinks)){
  stateURL<- stateLinks[i]
  stateTxt <- getURLContent(stateURL)
  stateDoc <- htmlParse(stateTxt)
  downloadLink <- xpathSApply(stateDoc, '//ol[@id="data_options"]/li/a/@href')

  #The HTML source code is poor so need to use grepl to extract .xls from Xpath results
  length(downloadLink)
  for (j in 1:length(downloadLink)){
     if (grepl(".xls", downloadLink[j])){
      downloadLinks[i] <- downloadLink[j]
      break 
    }
  }
}

AllStates$downloadLinks <- downloadLinks

AllStates$downloadLinks
 
```

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Downloading and loading Excel files (Method 1: Using Tempfiles)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


All the support functions:

Function that returns a dataframe with the base FIPS info from the 2010 census (with Oglala update maybe)
```{r}

FIPS_fun <- function(state = NA){
  #Note: colClasses = "character" helps keep the leading 0s
  #http://stackoverflow.com/questions/17414776/read-csv-warning-eof-within-quoted-string-prevents-complete-reading-of-file
  df <- read.table("https://www2.census.gov/geo/docs/reference/codes/files/national_county.txt", sep = ",", col.names = c("State", "StateFIPS", "CountyFIPS", "CountyName", "ClassFIPSCode" ), colClasses = "character", quote = "")
  
  #Shannon County (46-113) change to Oglala Lakota County (46-102) (Effective 2015)
  df2 <- data.frame(State = "SD", StateFIPS = "46", CountyFIPS = "102", CountyName = "Oglala Lakota County", ClassFIPSCode = "H1")
  df <- rbind(df, df2)
  
  #Merge state and county into one FIPS code
  FIPS_base <- df %>% mutate(FIPS = paste(StateFIPS, CountyFIPS, sep = ""))
  #iew(FIPS_base)
  
  #return FIPS codes of the state passed in
  if(!is.na(state)){
    df <- FIPS_base %>% subset(State == state) %>% select(State, CountyName, FIPS)
    return(df)
  }else{return(FIPS_base)}
  
  #Minimal dataframe to facilitate joins
  #FIPS_base_compact <- FIPS_base %>% select(c(State, CountyName, FIPS))
}

```


Function that extracts data from an excel file relating to the Tree canopy Covering (m2/person), Available green space (ha), and Tree canopy cover in developped regions (%) for each county in the state. This data, along with the County name and the FIPS code is returned as a data frame.

```{r}
extractStateData <- function(tmp, stateAbbrev){
  
  #Read-in relevant sheets (7 and 10)
  #Known bug: NC 7th sheet is actually sheet 8....grrrr.
  # Solution: sheet = string instead of sheet = integer when reading the excel file.
  
  #Known Bug: DC messes lots of things up due to sheet differences, naming, etc.
  # Solution: various fixes changing DC to District of Columbia and reading sheet 5 & 8 instead. Start at line 4 in sheet 8 because of the random space
  
  # tmp = "C:\\Users\\Katrlyn\\stats133Project\\AllStates\\Louisiana.xls"
  # stateAbbrev = "LA"
  
  if(stateAbbrev == "DC"){
    xl_7 <- read_excel(tmp, sheet = "5", skip = 3)
    xl_10 <- read_excel(tmp, sheet = "8", skip = 4) 
  }else{
    xl_7 <- read_excel(tmp, sheet = "7", skip = 3)
    xl_10 <- read_excel(tmp, sheet = "10", skip = 3)
  }
  
  #Clean and select relevant variables
  
  xl_7 <- xl_7 %>% select(c(`X__1`, `m2/person__1`, `Available green space (ha)`))
  #Units: Tree canopy Covering (m2/person), Available green space (ha)
  colnames(xl_7) <- c("CountyName","TreeCanopy", "AvailGreenSpace")
  
  xl_10 <- xl_10 %>% select(c(`X__1`, `Tree % h`))
  #Tree canopy cover in developped regions (%)
  colnames(xl_10) <- c("CountyName", "TreeCanopyCover")
  
  #Exclude the variable descriptions at the end of the sheet
  xl_10 <- na.omit(xl_10)
  
  #Join the two excel sheets to create one datframe of county data
  joined <- full_join(xl_7, xl_10, by = "CountyName")
  #get ride of statewide summary row
  joined_clean <- joined %>% subset(CountyName != "Statewide")
  #Add column of state Abbreviations to assist debugging later
  joined_clean$StateAbb <- rep(stateAbbrev, times = length(joined_clean$CountyName))
  

  #Add FIPS codes
  #Moved to main code to prevent looping error
  #stateAbbrev <- state.abb[match(AllStates$stateNames[1],state.name)]
  
  #Corrections:
  
  #Fix Washington DC Error. Must be called District of Columbia to find FIPS code
  if(stateAbbrev == "DC"){
    joined_clean[1, "CountyName"] <- "District of Columbia"
  } #else if(stateAbbrev == "LA"){
  #   joined_clean[28,"CountyName"] <- "LaSalle Parish"
  # }
  
  FIPS_base <- FIPS_fun(state = stateAbbrev)
  
  final_df <- full_join(joined_clean, FIPS_base, by = "CountyName")
  #View(final_df)
  return(final_df)

}

#names(df)[names(df) == 'old.var.name'] <- 'new.var.name'
  
```


Main Code:


Downloading and processing each state to extract all counties. 

THIS CODE IS NOT READY -- STILL DEBUGGING USING LOCAL XLS FILES
```{r, eval=FALSE}
for(i in 1:1){ #:length(AllStates$downloadLinks)){
  #Download xls file
  url <- AllStates$downloadLinks[31]
  tmp <- tempfile(fileext=".xls")
  download.file(url,destfile=tmp, mode="wb")
  
  stateAbbrev <- state.abb[match(AllStates$stateNames[31],state.name)]
  state_df <- extractStateData(tmp, stateAbbrev)
  
  if(i == 1){
    df_base <- state_df
    #View(df_base)
  }else if( i == 2){
    df_full <- rbind(df_base, state_df)
    #View(df_full)
  }else{
    df_full <- rbind(df_full, state_df)
    #View(df_full)
  }
  unlink(tmp)
  
}

View(df_full)


```

To keep from wasting time redownloading files, use this code to download once and use your local files. 
```{r, eval=FALSE}
library(readxl)

fileLocations <- vector(mode="character", length=length(AllStates$stateNames))
for(i in 1:length(AllStates$stateNames)){
  destination <- paste("/Users/anishakumar/Documents/Stats 133/RStudio Files/Stats133Project/AllStates", AllStates$stateNames[i], ".xls", sep = "")
  #"/Users/anishakumar/Documents/Stats 133/RStudio Files/Stats133Project/AllStates"
  #file must be handled locally during preprocessing.
  download.file(AllStates$downloadLinks[i], destfile = destination, mode = "wb" )
  
  fileLocations[i] <- destination
}

AllStates$fileLocations <- fileLocations

View(AllStates)
```

Load the filepaths if you're using the downloaded files
```{r}
AllStates$fileLocations <- paste("/Users/anishakumar/Documents/Stats 133/RStudio Files/Stats133Project/AllStates", AllStates$stateNames, ".xls", sep = "")
AllStates
```

Main code (assuming you downloaded all the files)
```{r}

for(i in 1:length(AllStates$downloadLinks)){
  print(AllStates$stateNames[i])
  print(AllStates$fileLocations[i])
  if(AllStates$stateNames[i] == "District of Columbia"){
    stateAbbrev <- "DC"
  }else{
    stateAbbrev <- state.abb[match(AllStates$stateNames[i],state.name)]
  }
  
  print(paste("Start", stateAbbrev))
  state_df <- extractStateData(AllStates$fileLocations[i], stateAbbrev)
  
  if(i == 1){
    df_base <- state_df
    #View(df_base)
  }else if( i == 2){
    df_full <- rbind(df_base, state_df)
    #View(df_full)
  }else{
    df_full <- rbind(df_full, state_df)
    #View(df_full)
  }
  #unlink(tmp)
  
}

View(df_full)

#Things that need fixing still
df <- df_full %>% subset(is.na(FIPS) | is.na(TreeCanopy))
df


###### MY CODE  SO THAT I CAN JOIN THE TREE DATA TO MY OTHER DATA FOR THE SCATTERPLOTS######
tree_data<-df_full[, -grep("State|Name", colnames(df_full))]
tree_data<-rename(tree_data, FIPSCode=FIPS)
```

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Joining all datatables 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

```{r}
all_data=NULL
all_data<-every_county%>%left_join(edu_data, by ='FIPSCode')
all_data<-all_data%>%full_join(income, by='FIPSCode')
all_data<-all_data%>%full_join(poll_county, by= 'FIPSCode')
all_data<-all_data%>%full_join(tree_data, by='FIPSCode')
#library(xlsx)
write.csv(all_data, "/Users/anishakumar/Documents/Stats 133/RStudio Files/Stats133Project/all_data.csv")
#"/Users/anishakumar/Documents/Stats 133/RStudio Files/Stats133Project/all_data.xlsx"
View(all_data)
```

